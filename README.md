# REST Player Game / LLM Based

API-сервис, представляющий собой текстовую ролевую онлайн-игру на базе LLM.

## Системные требования
- `Python` версии `3.12.4` или выше;
- `Poetry` версии `1.8.3` или выше.

## Установка

1. Склонируйте репозиторий:
```
git clone https://github.com/MegaDoge1337/rest_player_game.git
```

2. Заполните файл `.env` (см. раздел `Настройка`)

3. Заполните имя базы данных в файле `postgres_init.sql` (см. раздел `Настройка`)

4. Подготовьте директорию для хранения файлов СУБД (см. раздел `Настройка`)

5. Соберите Docker-образ:
```
docker-compose build
```

6. Запустите сервис:
```
docker-compose up -d
```

7. Примените миграции:
```
docker-compose exec server alembic upgrade head
```

## Настройка

1. Скопируйте файл `.env.example` как `.env` и заполните следующие переменные:

- `ASGI_APP` - приложение, которое будет обслуживать uvicorn, по умолчанию `infrastructure.api:app`;
- `HOST` - хост, который будет обслуживать uvicorn, по умолчанию `0.0.0.0`;
- `PORT` - порт, которое будет обслуживать uvicorn, по умолчанию `5000`;
- `SECRET_KEY` - секретная фраза для генерации JWT, по умолчанию `mysecretkey`;
- `ALGORITHM` - алгоритм хеширования для JWT, по умолчанию `HS256`;
- `ACCESS_TOKEN_EXPIRE_MINUTES` - время действия JWT-токена в минутах, по умолчанию `15`;
- `DB_CONNECTION_STRING` - строка подключения к СУБД, по умолчанию `postgresql://admin:1Qwerty@postgres/restplayergame`;
- `DB_POOL_SIZE` - максимальный размер пула соединений с БД, по умолчанию `20`;
- `DB_MAX_OVERFLOW` - максимальное переполнение пула соединений с БД, по умолчанию `30`;
- `LLM_BASE_URL` - URL сервера LLM (сервер должен поддерживать общение по HTTP в формате OpenAI-like API), по умолчанию `http://localhost:1234/v1`;
- `LLM_API_KEY` - API-ключ для доступа к серверу LLM, по умолчанию `lm-studio`;
- `LLM_MODEL` - имя языковой модели, по умочанию `aya-23-8b`;
- `LLM_TEMP` - температура языковой модели, по умолчанию `0.7`;
- `DEFAULT_SCORE` - значение очков пользователя при регистрации, по умолчанию `1`;
- `DEFAULT_INVENTORY` - перечень предметов инвентаря пользователя при регистрации (разделителем является запятая), по умолчанию `Палка,Камень`;
- `EVENTS_PAGE_LIMIT` - количество записей событий, которые возвращаются при получении списка, используется для пагинации списка событий, по умолчанию `3`.

2. Заполните желаемое имя БД в файле `postgres_init.sql`, при инициализации БД с данным именем будет создана автоматически.

3. Создайте в корне директории `./.docker/data/postgres`, или измените точку монтирования для сохранения данных СУБД:
```
.
└── .docker/
    └── data/
        └── postgres
```

## Документация к API

Для ознакомления с возможностями API-сервиса импортируйте коллекцию Postman из директории `.postman`. В коллекции содержаться примеры использования API с результатами выполнения.

## Проверка и тестирование

Для запуска инструментов форматирования или тестов используйте Makefile.

- Проверка форматирования
```
make format
```

- Запуск линтера
```
make lint
```

- Запуск тестов
```
make test
```

## Использование локальной LLM

Проект разрабатывался на базе модели [lmstudio-community/aya-23-8B-GGUF](https://huggingface.co/lmstudio-community/aya-23-8B-GGUF). Модель запускалась при помощи приложение LM Stuio. С примером запуска сервера модели можно ознакомится в [документации](https://lmstudio.ai/docs/app/api).